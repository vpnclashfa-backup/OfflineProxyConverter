# .github/workflows/build.yml
name: Build and Release Subconverter Desktop

on:
  schedule:
    - cron: '0 0 */3 * *'       # Every 3 days at midnight UTC
  workflow_dispatch:           # Manual trigger
  push:
    tags:
      - 'v*.*.*'               # On push of tags like vX.Y.Z

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get latest subconverter release info
      id: get_subconverter_release
      run: |
        $response = Invoke-RestMethod -Uri "https://api.github.com/repos/metacubex/subconverter/releases/latest" -Headers @{Authorization = "token ${{ secrets.GITHUB_TOKEN }}"}
        $latest_sub_tag = $response.tag_name
        $asset_url = $response.assets | Where-Object { $_.name -like "subconverter_win64*.7z" } | Select-Object -ExpandProperty browser_download_url
        echo "LATEST_SUB_TAG=$latest_sub_tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "SUB_ASSET_URL=$asset_url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell

    - name: Determine if build is needed
      id: build_decision
      run: |
        $latest_sub_tag = "${{ env.LATEST_SUB_TAG }}"
        $current_repo_commit_sha = "${{ github.sha }}"

        $current_release_tag = ""
        $last_release_commit_sha = ""
        $current_sub_version_in_release = ""

        try {
          $repo_release_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers @{Authorization = "token ${{ secrets.GITHUB_TOKEN }}"}
          $current_release_tag = $repo_release_response.tag_name
          if ($current_release_tag -match 'subconverter-desktop-(v\d+\.\d+\.\d+)-[0-9a-fA-F]+') {
            $current_sub_version_in_release = $Matches[1]
          }
          $tag_ref_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/git/ref/tags/$current_release_tag" -Headers @{Authorization = "token ${{ secrets.GITHUB_TOKEN }}"}
          $last_release_commit_sha = $tag_ref_response.object.sha
        } catch {
          Write-Host "No previous release found or fetch failed."
        }

        $build_needed = $false
        if (-not $current_release_tag) {
          Write-Host "First build."
          $build_needed = $true
        } elseif ($latest_sub_tag -ne $current_sub_version_in_release) {
          Write-Host "Engine version changed: $current_sub_version_in_release -> $latest_sub_tag"
          $build_needed = $true
        } elseif ($current_repo_commit_sha -ne $last_release_commit_sha) {
          Write-Host "Repo files changed: $last_release_commit_sha -> $current_repo_commit_sha"
          $build_needed = $true
        } else {
          Write-Host "No changes detected. Skipping build."
        }

        echo "FORCE_BUILD=$($build_needed.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell

    - name: Download and Extract subconverter.exe
      if: env.FORCE_BUILD == 'true'
      run: |
        if ("${{ env.SUB_ASSET_URL }}" -eq "") {
          Write-Error "Asset URL not found."
          exit 1
        }
        Invoke-WebRequest -Uri "${{ env.SUB_ASSET_URL }}" -OutFile "subconverter_release.7z"
        & "C:\Program Files\7-Zip\7z.exe" x "subconverter_release.7z" -o*
        $subconverterExe = Get-ChildItem -Recurse -Filter "subconverter.exe" | Select-Object -First 1
        if ($subconverterExe) {
          Move-Item -Path $subconverterExe.FullName -Destination "subconverter.exe" -Force
        } else {
          Write-Error "subconverter.exe not found."
          exit 1
        }
        Remove-Item -Force "subconverter_release.7z"
        Get-ChildItem -Directory -Filter "subconverter-windows-amd64-*" | Remove-Item -Recurse -Force
      shell: powershell

    - name: Install dependencies
      if: env.FORCE_BUILD == 'true'
      run: npm install

    - name: Build Electron application for Windows
      if: env.FORCE_BUILD == 'true'
      run: npm run build

    - name: Create Release
      id: create_release
      if: env.FORCE_BUILD == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: subconverter-desktop-${{ env.LATEST_SUB_TAG }}-${{ github.sha }}
        release_name: Subconverter Desktop with ${{ env.LATEST_SUB_TAG }} (Changes: ${{ github.sha }})
        body: >
          Automated build of Subconverter Desktop.
          **Subconverter Version:** ${{ env.LATEST_SUB_TAG }}
          **Project Commit ID:** ${{ github.sha }}
          This release updates on Subconverter engine or project file changes.
        draft: false
        prerelease: false

    - name: Upload Release Asset
      if: env.FORCE_BUILD == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/Subconverter\ Desktop-1.0.0-win.zip
        asset_name: Subconverter_Desktop_Win-${{ env.LATEST_SUB_TAG }}-${{ github.sha }}.zip
        asset_content_type: application/zip
